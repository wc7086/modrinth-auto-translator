name: 'Auto Translate Modrinth App'

on:
  workflow_dispatch:
    inputs:
      modrinth_tag:
        description: 'Modrinthç‰ˆæœ¬æ ‡ç­¾ (å¦‚: v0.9.5, main, æˆ– latest)'
        required: true
        default: 'latest'
        type: string
      target_languages:
        description: 'ç›®æ ‡è¯­è¨€ (é€—å·åˆ†éš”)'
        required: false
        default: 'zh-CN,ja-JP,ko-KR,fr-FR,de-DE,es-ES'
        type: string
      skip_translation:
        description: 'è·³è¿‡ç¿»è¯‘æ­¥éª¤'
        required: false
        default: false
        type: boolean
  
  schedule:
    # æ¯å‘¨æ—¥UTC 02:00è¿è¡Œï¼Œæ£€æŸ¥æ˜¯å¦æœ‰æ–°ç‰ˆæœ¬
    - cron: '0 2 * * 0'

env:
  MODRINTH_REPO: "modrinth/code"
  DEFAULT_TAG: "latest"
  NODE_VERSION: '18'
  RUST_VERSION: 'stable'

jobs:
  setup-and-translate:
    runs-on: ubuntu-latest
    outputs:
      has-translations: ${{ steps.check-translations.outputs.has-translations }}
      modrinth-version: ${{ steps.setup-modrinth.outputs.version }}
      release-name: ${{ steps.setup-modrinth.outputs.release-name }}
    
    steps:
      - name: Checkout translator repository
        uses: actions/checkout@v4
        with:
          path: translator

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Get Modrinth latest tag
        id: get-latest
        if: github.event.inputs.modrinth_tag == 'latest' || github.event.inputs.modrinth_tag == ''
        run: |
          echo "ğŸ” Getting Modrinth latest tag..."
          
          # Modrinthä¸å†ä½¿ç”¨GitHub releasesï¼Œæ”¹ç”¨git tags
          LATEST_TAG=$(curl -s https://api.github.com/repos/${{ env.MODRINTH_REPO }}/tags | jq -r '.[0].name')
          
          if [ "$LATEST_TAG" != "null" ] && [ -n "$LATEST_TAG" ]; then
            echo "latest-tag=$LATEST_TAG" >> $GITHUB_OUTPUT
            echo "ğŸ“‹ Latest Modrinth tag: $LATEST_TAG"
          else
            echo "latest-tag=main" >> $GITHUB_OUTPUT
            echo "âš ï¸ No tags found, using main branch"
          fi

      - name: Determine Modrinth version
        id: determine-version
        run: |
          if [ "${{ github.event.inputs.modrinth_tag }}" = "latest" ]; then
            VERSION="${{ steps.get-latest.outputs.latest-tag }}"
          elif [ -z "${{ github.event.inputs.modrinth_tag }}" ]; then
            VERSION="main"
          else
            VERSION="${{ github.event.inputs.modrinth_tag }}"
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "ğŸ¯ Using Modrinth version: $VERSION"

      - name: Clone Modrinth source code
        id: setup-modrinth
        run: |
          VERSION="${{ steps.determine-version.outputs.version }}"
          echo "ğŸ“¥ Cloning Modrinth $VERSION..."
          
          # æ£€æŸ¥ç‰ˆæœ¬æ˜¯å¦å­˜åœ¨
          if [ "$VERSION" = "latest" ]; then
            echo "âš ï¸ Latest tag specified, getting actual latest release..."
            ACTUAL_VERSION=$(curl -s https://api.github.com/repos/${{ env.MODRINTH_REPO }}/releases/latest | jq -r .tag_name)
            echo "ğŸ¯ Actual latest version: $ACTUAL_VERSION"
            VERSION="$ACTUAL_VERSION"
          fi
          
          # å°è¯•å…‹éš†æŒ‡å®šç‰ˆæœ¬ï¼Œå¦‚æœå¤±è´¥åˆ™å…‹éš†mainåˆ†æ”¯
          if git clone --depth 1 --branch "$VERSION" https://github.com/${{ env.MODRINTH_REPO }}.git modrinth-source; then
            echo "âœ… Successfully cloned version $VERSION"
          else
            echo "âš ï¸ Failed to clone version $VERSION, trying main branch..."
            git clone --depth 1 --branch main https://github.com/${{ env.MODRINTH_REPO }}.git modrinth-source
            VERSION="main-$(date +%Y%m%d)"
            echo "âœ… Cloned main branch, using version: $VERSION"
          fi
          
          cd modrinth-source
          COMMIT_SHA=$(git rev-parse HEAD)
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "commit-sha=$COMMIT_SHA" >> $GITHUB_OUTPUT
          echo "release-name=Modrinth-Multilang-$VERSION" >> $GITHUB_OUTPUT
          
          echo "âœ… Cloned Modrinth $VERSION (commit: ${COMMIT_SHA:0:8})"
          
          # æ˜¾ç¤ºé¡¹ç›®ç»“æ„
          echo "ğŸ“ Project structure:"
          ls -la
          echo "ğŸ“± Apps directory structure:"
          ls -la apps/ || echo "âš ï¸ Apps directory not found"
          echo "ğŸ¯ App-frontend structure:"
          ls -la apps/app-frontend/ || echo "âš ï¸ App-frontend directory not found"
          echo "ğŸ§© Components structure:"
          ls -la apps/app-frontend/src/components/ || echo "âš ï¸ Components directory not found"

      - name: Install translation dependencies
        run: |
          cd translator
          echo "ğŸ“¦ Installing translation dependencies..."
          npm install
          # å®‰è£…é¢å¤–ä¾èµ–
          npm install glob @types/node
          echo "âœ… Dependencies installed successfully"
          echo "ğŸ“‹ Installed packages:"
          npm list --depth=0

      - name: Extract translation strings
        id: extract
        run: |
          cd translator
          echo "ğŸ” Extracting translations from Modrinth source..."
          
          # æ£€æŸ¥å·¥ä½œç›®å½•å’Œæºç è·¯å¾„
          echo "ğŸ“ Current working directory: $(pwd)"
          echo "ğŸ“ Translator directory contents:"
          ls -la
          echo "ğŸ“‚ Parent directory contents:"
          ls -la ..
          echo "ğŸ¯ Modrinth source path check:"
          ls -la ../modrinth-source || echo "âŒ Modrinth source not found"
          
          # è®¾ç½®æºç è·¯å¾„
          export MODRINTH_SOURCE_PATH="../modrinth-source"
          
          # è¿è¡Œæå–è„šæœ¬
          echo "ğŸš€ Running extraction script..."
          node scripts/extract-modrinth-translations.js ../modrinth-source modrinth-translations.json || {
            echo "âŒ Extraction script failed with exit code $?"
            echo "ğŸ“‹ Let's check what went wrong..."
            ls -la ../modrinth-source/apps/ || echo "No apps directory"
            exit 1
          }
          
          # æ£€æŸ¥æå–ç»“æœ
          if [ -f "modrinth-translations.json" ]; then
            echo "âœ… Translation file created"
            echo "ğŸ“„ File size: $(wc -c < modrinth-translations.json) bytes"
            TOTAL_KEYS=$(node -e "
              try {
                const data = JSON.parse(require('fs').readFileSync('modrinth-translations.json', 'utf8'));
                console.log(data.totalKeys || 0);
              } catch(e) {
                console.log('0');
              }
            ")
            echo "total-keys=$TOTAL_KEYS" >> $GITHUB_OUTPUT
            echo "ğŸ“Š Extracted $TOTAL_KEYS translation keys"
            
            # æ˜¾ç¤ºå‰å‡ ä¸ªé”®ä½œä¸ºæ ·æœ¬
            echo "ğŸ” Sample translation keys:"
            node -e "
              try {
                const data = JSON.parse(require('fs').readFileSync('modrinth-translations.json', 'utf8'));
                const files = Object.keys(data.details || {});
                console.log('Files found:', files.length);
                files.slice(0, 3).forEach(file => {
                  const keys = Object.keys(data.details[file] || {});
                  console.log(\`  \${file}: \${keys.length} keys\`);
                  if (keys.length > 0) {
                    console.log(\`    Sample: \${keys.slice(0, 2).join(', ')}\`);
                  }
                });
              } catch(e) {
                console.log('Error reading translation file:', e.message);
              }
            "
          else
            echo "total-keys=0" >> $GITHUB_OUTPUT
            echo "âŒ No translation file created"
          fi

      - name: Check translations
        id: check-translations
        run: |
          cd translator
          TOTAL_KEYS="${{ steps.extract.outputs.total-keys }}"
          if [ "$TOTAL_KEYS" -gt 0 ]; then
            echo "has-translations=true" >> $GITHUB_OUTPUT
            echo "âœ… Found $TOTAL_KEYS translation keys"
          else
            echo "has-translations=false" >> $GITHUB_OUTPUT
            echo "âš ï¸ No translations to process"
          fi

      - name: Setup target languages
        id: setup-languages
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ] && [ -n "${{ github.event.inputs.target_languages }}" ]; then
            LANGUAGES="${{ github.event.inputs.target_languages }}"
          else
            LANGUAGES="zh-CN,ja-JP,ko-KR,fr-FR,de-DE,es-ES"
          fi
          echo "languages=$LANGUAGES" >> $GITHUB_OUTPUT
          echo "ğŸŒ Target languages: $LANGUAGES"

      - name: Translate content
        if: steps.check-translations.outputs.has-translations == 'true' && !inputs.skip_translation
        env:
          TRANSLATION_API_KEY: ${{ secrets.TRANSLATION_API_KEY }}
          TRANSLATION_API_URL: ${{ secrets.TRANSLATION_API_URL }}
          TRANSLATION_MODEL: ${{ secrets.TRANSLATION_MODEL }}
        run: |
          cd translator
          echo "ğŸŒ Starting translation process..."
          
          # è®¾ç½®ç›®æ ‡è¯­è¨€
          export TARGET_LANGUAGES="${{ steps.setup-languages.outputs.languages }}"
          
          # è¿è¡Œç¿»è¯‘
          node scripts/translate-modrinth.js modrinth-translations.json ../modrinth-source
          
          # æ£€æŸ¥ç¿»è¯‘ç»“æœ
          if [ -d "../modrinth-source/apps/app-frontend/src/locales" ]; then
            echo "âœ… Translation completed"
            echo "ğŸ“ Generated language directories:"
            ls -la ../modrinth-source/apps/app-frontend/src/locales/
          else
            echo "âŒ Translation failed"
            exit 1
          fi

      - name: Upload translation artifacts
        if: steps.check-translations.outputs.has-translations == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: modrinth-translated-source
          path: |
            modrinth-source/
            translator/modrinth-translations.json
          retention-days: 7

  build-apps:
    needs: setup-and-translate
    if: always() && needs.setup-and-translate.outputs.has-translations == 'true'
    strategy:
      fail-fast: false
      matrix:
        platform: [ubuntu-22.04, windows-latest, macos-latest]

    runs-on: ${{ matrix.platform }}

    steps:
      - name: Download translated source
        uses: actions/download-artifact@v4
        with:
          name: modrinth-translated-source
          path: .

      - name: Setup Rust
        if: startsWith(matrix.platform, 'macos')
        uses: actions-rust-lang/setup-rust-toolchain@v1
        with:
          rustflags: ''
          target: x86_64-apple-darwin

      - name: Setup Rust
        if: "!startsWith(matrix.platform, 'macos')"
        uses: actions-rust-lang/setup-rust-toolchain@v1
        with:
          rustflags: ''

      - name: Setup Rust cache
        uses: actions/cache@v4
        with:
          path: |
            modrinth-source/target
            ~/.cargo/registry
            ~/.cargo/git
          key: ${{ runner.os }}-modrinth-app-${{ hashFiles('modrinth-source/apps/app/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-modrinth-app-

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install pnpm
        shell: bash
        run: |
          corepack enable
          corepack prepare --activate

      - name: Setup pnpm cache
        uses: actions/cache@v4
        with:
          path: ~/.pnpm-store
          key: ${{ runner.os }}-pnpm-modrinth-${{ hashFiles('modrinth-source/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-modrinth-

      - name: Install system dependencies (Ubuntu)
        if: startsWith(matrix.platform, 'ubuntu')
        run: |
          sudo apt-get update
          sudo apt-get install -y libwebkit2gtk-4.1-dev build-essential curl wget file libxdo-dev libssl-dev pkg-config libayatana-appindicator3-dev librsvg2-dev

      - name: Install Node.js dependencies
        run: |
          cd modrinth-source
          echo "ğŸ“¦ Installing dependencies..."
          pnpm install
          
          # æ˜¾ç¤ºå¯ç”¨çš„ç¿»è¯‘
          if [ -d "apps/app-frontend/src/locales" ]; then
            echo "ğŸŒ Available translations:"
            ls -la apps/app-frontend/src/locales/
          fi

      - name: Build Modrinth App (macOS)
        if: startsWith(matrix.platform, 'macos')
        run: |
          cd modrinth-source/apps/app
          echo "ğŸ Building Modrinth App for macOS..."
          pnpm run tauri build --target universal-apple-darwin
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          ENABLE_CODE_SIGNING: ${{ secrets.APPLE_CERTIFICATE }}
          APPLE_CERTIFICATE: ${{ secrets.APPLE_CERTIFICATE }}
          APPLE_CERTIFICATE_PASSWORD: ${{ secrets.APPLE_CERTIFICATE_PASSWORD }}
          APPLE_SIGNING_IDENTITY: ${{ secrets.APPLE_SIGNING_IDENTITY }}
          APPLE_ID: ${{ secrets.APPLE_ID }}
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
          APPLE_PASSWORD: ${{ secrets.APPLE_PASSWORD }}
          TAURI_SIGNING_PRIVATE_KEY: ${{ secrets.TAURI_PRIVATE_KEY }}
          TAURI_SIGNING_PRIVATE_KEY_PASSWORD: ${{ secrets.TAURI_KEY_PASSWORD }}

      - name: Build Modrinth App (Windows/Linux)
        if: "!startsWith(matrix.platform, 'macos')"
        run: |
          cd modrinth-source/apps/app
          echo "ğŸ—ï¸ Building Modrinth App for ${{ matrix.platform }}..."
          pnpm run tauri build
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          TAURI_SIGNING_PRIVATE_KEY: ${{ secrets.TAURI_PRIVATE_KEY }}
          TAURI_SIGNING_PRIVATE_KEY_PASSWORD: ${{ secrets.TAURI_KEY_PASSWORD }}

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: modrinth-app-${{ matrix.platform }}
          path: |
            modrinth-source/apps/app/target/*/release/bundle/*/*.dmg
            modrinth-source/apps/app/target/*/release/bundle/*/*.app.tar.gz
            modrinth-source/apps/app/target/*/release/bundle/*/*.app.tar.gz.sig
            modrinth-source/apps/app/target/release/bundle/*/*.dmg
            modrinth-source/apps/app/target/release/bundle/*/*.app.tar.gz
            modrinth-source/apps/app/target/release/bundle/*/*.app.tar.gz.sig
            modrinth-source/apps/app/target/release/bundle/*/*.AppImage
            modrinth-source/apps/app/target/release/bundle/*/*.AppImage.tar.gz
            modrinth-source/apps/app/target/release/bundle/*/*.AppImage.tar.gz.sig
            modrinth-source/apps/app/target/release/bundle/*/*.deb
            modrinth-source/apps/app/target/release/bundle/*/*.rpm
            modrinth-source/apps/app/target/release/bundle/msi/*.msi
            modrinth-source/apps/app/target/release/bundle/msi/*.msi.zip
            modrinth-source/apps/app/target/release/bundle/msi/*.msi.zip.sig
            modrinth-source/apps/app/target/release/bundle/nsis/*.exe
            modrinth-source/apps/app/target/release/bundle/nsis/*.nsis.zip
            modrinth-source/apps/app/target/release/bundle/nsis/*.nsis.zip.sig
          if-no-files-found: error

  create-release:
    needs: [setup-and-translate, build-apps]
    if: always() && !cancelled() && needs.setup-and-translate.outputs.has-translations == 'true'
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout translator repository
        uses: actions/checkout@v4

      - name: Download all build artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Prepare release assets
        run: |
          mkdir -p release-assets
          
          # æ”¶é›†æ‰€æœ‰æ„å»ºäº§ç‰©
          echo "ğŸ“¦ Collecting build artifacts..."
          find artifacts -name "*.dmg" -o -name "*.app.tar.gz" -o -name "*.AppImage" -o -name "*.deb" -o -name "*.rpm" -o -name "*.msi" -o -name "*.exe" | while read file; do
            filename=$(basename "$file")
            # é‡å‘½åä»¥åŒ…å«è¯­è¨€ä¿¡æ¯
            new_name="Modrinth-Multilang-${filename}"
            cp "$file" "release-assets/$new_name"
            echo "  ğŸ“„ $new_name"
          done
          
          # æ”¶é›†ç­¾åæ–‡ä»¶
          find artifacts -name "*.sig" | while read file; do
            filename=$(basename "$file")
            new_name="Modrinth-Multilang-${filename}"
            cp "$file" "release-assets/$new_name"
          done
          
          echo "ğŸ“Š Release assets prepared:"
          ls -la release-assets/

      - name: Get release information
        id: release-info
        run: |
          MODRINTH_VERSION="${{ needs.setup-and-translate.outputs.modrinth-version }}"
          RELEASE_NAME="${{ needs.setup-and-translate.outputs.release-name }}"
          RELEASE_TAG="multilang-$MODRINTH_VERSION-$(date +%Y%m%d)"
          
          echo "modrinth-version=$MODRINTH_VERSION" >> $GITHUB_OUTPUT
          echo "release-name=$RELEASE_NAME" >> $GITHUB_OUTPUT
          echo "release-tag=$RELEASE_TAG" >> $GITHUB_OUTPUT
          
          echo "ğŸ·ï¸ Release tag: $RELEASE_TAG"
          echo "ğŸ“¦ Release name: $RELEASE_NAME"

      - name: Generate release notes
        id: release-notes
        run: |
          MODRINTH_VERSION="${{ steps.release-info.outputs.modrinth-version }}"
          
          cat > release-notes.md << EOF
          # ğŸŒ Modrinth App å¤šè¯­è¨€ç‰ˆæœ¬ - $MODRINTH_VERSION
          
          åŸºäº Modrinth å®˜æ–¹ç‰ˆæœ¬ [\`$MODRINTH_VERSION\`](https://github.com/modrinth/code/releases/tag/$MODRINTH_VERSION) æ„å»ºçš„å¤šè¯­è¨€ç‰ˆæœ¬ã€‚
          
          ## âœ¨ æ–°å¢åŠŸèƒ½
          
          - ğŸŒ **å¤šè¯­è¨€ç•Œé¢æ”¯æŒ**
            - ç®€ä½“ä¸­æ–‡ (zh-CN)
            - æ—¥è¯­ (ja-JP) 
            - éŸ©è¯­ (ko-KR)
            - æ³•è¯­ (fr-FR)
            - å¾·è¯­ (de-DE)
            - è¥¿ç­ç‰™è¯­ (es-ES)
          
          - ğŸ”„ **è‡ªåŠ¨ç¿»è¯‘ç³»ç»Ÿ**
            - AIé©±åŠ¨çš„é«˜è´¨é‡ç¿»è¯‘
            - æ™ºèƒ½ä¿æŒæ ¼å¼å’Œå ä½ç¬¦
            - å¢é‡æ›´æ–°æ”¯æŒ
          
          - ğŸ¯ **å®Œæ•´åŠŸèƒ½ä¿æŒ**
            - æ‰€æœ‰åŸç‰ˆModrinthåŠŸèƒ½
            - å®Œå…¨å…¼å®¹å®˜æ–¹ç‰ˆæœ¬
            - è‡ªåŠ¨è¯­è¨€æ£€æµ‹
          
          ## ğŸ“¦ ä¸‹è½½æŒ‡å—
          
          ### Windows
          - **å®‰è£…åŒ…**: \`Modrinth-Multilang-*.exe\` 
          - **ä¾¿æºç‰ˆ**: \`Modrinth-Multilang-*.msi\`
          
          ### macOS
          - **é€šç”¨ç‰ˆæœ¬**: \`Modrinth-Multilang-*.dmg\` (æ”¯æŒIntel + Apple Silicon)
          
          ### Linux
          - **AppImage**: \`Modrinth-Multilang-*.AppImage\` (é€šç”¨)
          - **Debian/Ubuntu**: \`Modrinth-Multilang-*.deb\`
          - **Red Hat/CentOS**: \`Modrinth-Multilang-*.rpm\`
          
          ## ğŸ” å®‰å…¨éªŒè¯
          
          æ‰€æœ‰æ–‡ä»¶éƒ½åŒ…å«å¯¹åº”çš„ \`.sig\` ç­¾åæ–‡ä»¶ï¼Œå¯ç”¨äºéªŒè¯æ–‡ä»¶å®Œæ•´æ€§ã€‚
          
          ## ğŸš€ ä½¿ç”¨è¯´æ˜
          
          1. ä¸‹è½½å¯¹åº”å¹³å°çš„å®‰è£…åŒ…
          2. å®‰è£…å¹¶å¯åŠ¨åº”ç”¨
          3. åº”ç”¨ä¼šæ ¹æ®ç³»ç»Ÿè¯­è¨€è‡ªåŠ¨é€‰æ‹©ç•Œé¢è¯­è¨€
          4. ä¹Ÿå¯åœ¨è®¾ç½®ä¸­æ‰‹åŠ¨åˆ‡æ¢è¯­è¨€
          
          ## ğŸ“Š æŠ€æœ¯ä¿¡æ¯
          
          - **åŸç‰ˆç‰ˆæœ¬**: $MODRINTH_VERSION
          - **æ„å»ºæ—¶é—´**: $(date -u +"%Y-%m-%d %H:%M:%S UTC")
          - **ç¿»è¯‘å¼•æ“**: OpenAI GPT-3.5-turbo
          - **æ„å»ºç³»ç»Ÿ**: GitHub Actions
          
          ## ğŸ› é—®é¢˜åé¦ˆ
          
          å¦‚æœé‡åˆ°ç¿»è¯‘é—®é¢˜æˆ–å…¶ä»–Bugï¼Œè¯·åœ¨æœ¬ä»“åº“æäº¤Issueã€‚
          
          å¯¹äºModrinthæœ¬èº«çš„åŠŸèƒ½é—®é¢˜ï¼Œè¯·è®¿é—®[å®˜æ–¹ä»“åº“](https://github.com/modrinth/code)ã€‚
          
          ---
          
          ğŸ‰ **æ„Ÿè°¢ä½¿ç”¨Modrinthå¤šè¯­è¨€ç‰ˆæœ¬ï¼**
          EOF
          
          echo "Release notes generated"

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.release-info.outputs.release-tag }}
          name: ${{ steps.release-info.outputs.release-name }}
          body_path: release-notes.md
          files: release-assets/*
          draft: false
          prerelease: false
          generate_release_notes: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Output release information
        run: |
          echo "âœ… Release created successfully!"
          echo "ğŸ·ï¸ Tag: ${{ steps.release-info.outputs.release-tag }}"
          echo "ğŸ“¦ Name: ${{ steps.release-info.outputs.release-name }}"
          echo "ğŸŒ Languages: ${{ needs.setup-and-translate.outputs.languages }}"
          echo "ğŸ”— URL: https://github.com/${{ github.repository }}/releases/tag/${{ steps.release-info.outputs.release-tag }}"